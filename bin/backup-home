#!/bin/bash

set -e

timestamp="`date +%Y-%m-%d-%H-%M-%S`"
copy_name="home-backup-$timestamp"
home_files=(
  .backup-exclude-rules
  .bash*
  .config
  pro
  data/part/safe.fs
)
backups_dir="$PWD/data/backup"
destination="$backups_dir/$copy_name"
archive_name="$copy_name.tar.xz"

main() {
  make_copy
  archive_copy
  remove_old_copy
}

make_copy() {
  options=(
    --archive
    --compress # Compress data sent.
    --relative
    --exclude-from=- # Read exclude rules from input.
  )
  mkdir -p "$destination"
  cd /home/p
  write_exclude_list | rsync ${options[@]} ${home_files[@]} "$destination"
}

archive_copy() {
  cd "$backups_dir"
  export XZ_OPT="--lzma2=preset=0,dict=256MiB --memlimit-compress=12GiB"
  tar -cJf "$archive_name" "$copy_name"
  unset XZ_OPT
}

remove_old_copy() {
  rm -fr "$destination"
}

write_exclude_list() {
  # Write global rules (and trim whitespace).
  sed -e 's/^ *//' <<END
    *~
    *.swp
    *.swo
END

  # Write local rules if they exist.
  if [ -f ~/.backup-exclude-rules ]; then
    cat ~/.backup-exclude-rules
  fi
}

main
