#!/bin/bash

set -e

partitions=(
  eth
  null
  safe
)

main() {
  sudo true
  subcommand-"$@"
}

subcommand-up() {
  if [[ $# -eq 0 ]]; then
    map bring-up "${partitions[@]}"
  else
    map bring-up "$@"
  fi
}

subcommand-down() {
  if [[ $# -eq 0 ]]; then
    map bring-down "${partitions[@]}"
  else
    map bring-down "$@"
  fi
}

map() {
  local func="$1"
  shift
  for arg in "$@"; do
    "$func" "$arg"
  done
}

bring-up() {
  if [[ -e /dev/mapper/$1 ]]; then
    echo "$1 was up"
    return
  fi
  sudo cryptsetup luksOpen "/home/p/data/part/${1}.fs" "$1"
  sudo mount "/dev/mapper/$1" "/$1"
}

bring-down() {
  if [[ ! -e /dev/mapper/$1 ]]; then
    echo "$1 was down"
    return
  fi
  case "$PWD/" in
    /$1/*)
      cd
      echo "changed dir to $PWD"
      ;;
  esac
  sudo umount "/$1"
  sudo cryptsetup luksClose "$1"
  echo "$1 is down"
}

main "$@"
