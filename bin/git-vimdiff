#!/usr/bin/env bash

set -e

diff_command="$HOME/.git-diff-command"
temp_dir=
collector_file=

main() {
  trap cleanup EXIT
  temp_dir="$(mktemp -d)"
  collector_file="$temp_dir/collect"

  create_diff_command "$@"
  git difftool -x "$diff_command" --no-prompt "$@"
  vim "+$(construct_vim_arguments)"
}

create_diff_command() {
  touch "$collector_file"
  cat > "$diff_command" <<END
#!/usr/bin/env bash
echo "\$2" >> "$collector_file"
file="\$(wc -l < "$collector_file")"
cp "\$1" "${temp_dir}/\$file"
echo "${temp_dir}/\$file" >> "$collector_file"
END
  chmod +x "$diff_command"
}

construct_vim_arguments() {
  while read -r line; do
    echo "tabe $line | 1 | let asdf=&syntax | "
    read -r line
    echo "vert diffsplit $line | 1 | exec \"set syntax=\" . asdf | wincmd l | "
  done < "$collector_file"
  echo " tabfirst | q"
}

cleanup() {
  rm -fr "$temp_dir" "$diff_command"
}

main "$@"
